---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const collections = ["news", "anniversari", "compleanni", "eventi", "cortometraggi"];

  const all = await Promise.all(
    collections.map(async (c) => {
      const entries = await getCollection(c);
      return entries.map((e) => ({
        params: { collection: c, slug: e.slug },
        props: { collection: c, entry: e },
      }));
    })
  );

  return all.flat();
}

const { entry, collection } = Astro.props;
const { Content } = await render(entry);

const d = new Date(entry.data.date);
const dateStr = d.toLocaleDateString("it-IT", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const pageTitle = `${entry.data.title} | SDAC Magazine`;

const coverSrc = entry.data.cover_image ?? null;
const coverAlt = entry.data.cover_alt ?? entry.data.title ?? "";
const coverFit = entry.data.cover_fit ?? "cover";

const posMap = {
  "center": "50% 50%",
  "top": "50% 0%",
  "bottom": "50% 100%",
  "left": "0% 50%",
  "right": "100% 50%",
  "top-left": "0% 0%",
  "top-right": "100% 0%",
  "bottom-left": "0% 100%",
  "bottom-right": "100% 100%",
};

const coverPositionKey = entry.data.cover_position ?? "center";
const coverPosition = posMap[coverPositionKey] ?? "50% 50%";

const gallery = entry.data.gallery ?? [];
const shareTitle = entry.data.title ?? "SDAC Magazine";
const shareText = entry.data.excerpt ?? `Leggi questo articolo su SDAC Magazine: ${shareTitle}`;
---

<BaseLayout title={pageTitle} current={collection}>
  <article class="article">
    <div class="meta">
      <span class="badge">{collection}</span> · {dateStr} · {entry.data.author}
      {entry.data.featured ? <span class="badge featured">In evidenza</span> : null}
    </div>

    <h1>{entry.data.title}</h1>
    {entry.data.excerpt ? <p class="meta">{entry.data.excerpt}</p> : null}

    {coverSrc ? (
      <img
        class="cover"
        src={coverSrc}
        alt={coverAlt}
        loading="lazy"
        style={`object-fit:${coverFit}; object-position:${coverPosition};`}
      />
    ) : null}

    <div class="prose" style="margin-top:16px">
      <Content />
    </div>

    {gallery.length ? (
      <section class="gallery" aria-label="Gallery">
        {gallery.map((g) => (
          <figure class={`gitem ${g.layout ?? "full"} ${g.size ?? "md"}`}>
            <img src={g.image} alt={g.alt ?? ""} loading="lazy" />
            {g.caption ? <figcaption>{g.caption}</figcaption> : null}
          </figure>
        ))}
      </section>
    ) : null}

<div class="share-box">
  <button class="share-btn" type="button" id="share-native">Condividi</button>

  <div class="share-links">
    <a id="share-whatsapp" target="_blank" rel="noopener noreferrer">WhatsApp</a>
    <a id="share-email">Email</a>
    <button class="share-link-btn" type="button" id="share-copy">Copia link</button>
  </div>

  <p class="share-feedback" id="share-feedback" aria-live="polite"></p>
</div>

    <p class="meta" style="margin-top:18px">
      <a href={`/${collection}`}>← Torna a {collection}</a>
    </p>
  </article>

<script is:inline>
  (() => {
    const pageUrl = window.location.href;
    const pageTitle = {JSON.stringify(shareTitle)};
    const pageText = {JSON.stringify(shareText)};

    const btnNative = document.getElementById("share-native");
    const btnWhatsApp = document.getElementById("share-whatsapp");
    const btnEmail = document.getElementById("share-email");
    const btnCopy = document.getElementById("share-copy");
    const feedback = document.getElementById("share-feedback");

    const encodedUrl = encodeURIComponent(pageUrl);
    const encodedText = encodeURIComponent(`${pageTitle}\n${pageUrl}`);
    const encodedMailSubject = encodeURIComponent(pageTitle);
    const encodedMailBody = encodeURIComponent(`${pageText}\n\n${pageUrl}`);

    if (btnWhatsApp) {
      btnWhatsApp.setAttribute("href", `https://wa.me/?text=${encodedText}`);
    }

    if (btnEmail) {
      btnEmail.setAttribute("href", `mailto:?subject=${encodedMailSubject}&body=${encodedMailBody}`);
    }

    if (btnNative) {
      btnNative.addEventListener("click", async () => {
        if (navigator.share) {
          try {
            await navigator.share({
              title: pageTitle,
              text: pageText,
              url: pageUrl,
            });
            if (feedback) feedback.textContent = "";
          } catch (err) {
            // l'utente può annullare, quindi non facciamo drammi
          }
        } else {
          if (feedback) feedback.textContent = "Condivisione nativa non disponibile su questo browser.";
        }
      });
    }

    if (btnCopy) {
      btnCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(pageUrl);
          if (feedback) feedback.textContent = "Link copiato.";
        } catch (err) {
          if (feedback) feedback.textContent = "Impossibile copiare il link.";
        }
      });
    }
  })();
</script>

  <style>
    .cover {
      width: 100%;
      max-height: 420px;
      height: auto;
      border-radius: 14px;
      background: #eee;
      display: block;
    }

    .badge.featured {
      margin-left: 8px;
    }

    .gallery {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .gitem {
      margin: 0;
    }

    .gitem img {
      width: 100%;
      height: auto;
      border-radius: 14px;
      display: block;
      background: #eee;
    }

    .gitem figcaption {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-top: 8px;
      line-height: 1.35;
    }

    .gitem.full { align-self: center; max-width: 980px; width: 100%; }
    .gitem.left { align-self: flex-start; }
    .gitem.right { align-self: flex-end; }

    .gitem.sm { max-width: 420px; width: 100%; }
    .gitem.md { max-width: 620px; width: 100%; }
    .gitem.lg { max-width: 980px; width: 100%; }

    @media (max-width: 640px) {
      .cover { max-height: 320px; }
      .gitem.left, .gitem.right { align-self: center; }
      .gitem.sm, .gitem.md, .gitem.lg { max-width: 100%; }
    }

    .prose :global(.article-figure) {
      margin: 18px 0;
    }

    .prose :global(.article-figure img) {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 14px;
      background: #eee;
    }

    .prose :global(.article-figure figcaption) {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-top: 8px;
      line-height: 1.35;
    }

    .prose :global(.article-figure.full) {
      width: 100%;
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    }

    .prose :global(.article-figure.left) {
      width: 100%;
      margin-left: 0;
      margin-right: auto;
    }

    .prose :global(.article-figure.right) {
      width: 100%;
      margin-left: auto;
      margin-right: 0;
    }

    .prose :global(.article-figure.sm) {
      max-width: 420px;
    }

    .prose :global(.article-figure.md) {
      max-width: 620px;
    }

    .prose :global(.article-figure.lg) {
      max-width: 980px;
    }

    @media (max-width: 640px) {
      .prose :global(.article-figure.full),
      .prose :global(.article-figure.left),
      .prose :global(.article-figure.right),
      .prose :global(.article-figure.sm),
      .prose :global(.article-figure.md),
      .prose :global(.article-figure.lg) {
        max-width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
    }
.share-box {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid rgba(0, 0, 0, 0.12);
}

.share-btn,
.share-link-btn {
  appearance: none;
  border: 1px solid #ccc;
  background: #fff;
  border-radius: 12px;
  padding: 10px 14px;
  font: inherit;
  cursor: pointer;
}

.share-links {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 12px;
}

.share-links a,
.share-link-btn {
  text-decoration: none;
  color: inherit;
}

.share-feedback {
  margin-top: 10px;
  min-height: 1.2em;
  font-size: 0.95rem;
  opacity: 0.8;
}

@media (max-width: 640px) {
  .share-links {
    gap: 8px;
  }

  .share-btn,
  .share-link-btn {
    width: 100%;
  }

  .share-links a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ccc;
    border-radius: 12px;
    padding: 10px 14px;
    width: 100%;
  }
}

  </style>
</BaseLayout>
